trigger:
  - main

variables:
  imageName: joke-app
  acrName: jokeapp
  tag: $(Build.BuildId)

pool:
  name: Self-Hosted-Pool

stages:
# =============================
# STAGE 1: BUILD & PUSH IMAGE
# =============================
- stage: Build
  displayName: Build and Push Docker Image
  jobs:
    - job: BuildJob
      displayName: Docker Build Job
      steps:
        - task: Docker@2
          displayName: Build and Push Image to ACR (AMD64)
          inputs:
            containerRegistry: 'jokeapp-service-connection'
            repository: '$(imageName)'
            command: 'buildAndPush'
            Dockerfile: '**/Dockerfile'
            tags: |
              $(tag)
            buildArguments: '--platform=linux/amd64'

# =============================
# STAGE 2: DEPLOY TO AKS
# =============================
- stage: Deploy
  displayName: Deploy to AKS
  dependsOn: Build
  condition: succeeded()
  jobs:
    - job: DeployJob
      displayName: AKS Deploy Job
      steps:
        # üîÅ Replace __TAG__ in all YAML manifests
        - script: |
            echo "Replacing __TAG__ with $(tag) in all manifests..."
            find manifests/ -type f -name "*.yaml" -exec sed -i "s|__TAG__|$(tag)|g" {} \;
            echo "Updated manifests:"
            find manifests/ -type f -name "*.yaml" -exec cat {} \;
          displayName: Replace image tag in manifests

        # ‚úÖ Apply all Kubernetes manifests
        - task: Kubernetes@1
          displayName: Apply Kubernetes Manifests
          inputs:
            connectionType: 'Kubernetes Service Connection'
            kubernetesServiceEndpoint: 'aks-k8s-connection'
            namespace: 'default'
            command: 'apply'
            useConfigurationFile: true
            configuration: 'manifests/'
